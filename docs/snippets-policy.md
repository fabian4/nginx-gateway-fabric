# SnippetsPolicy

The `SnippetsPolicy` Custom Resource Definition (CRD) allows you to inject NGINX snippets into the configuration generated by NGINX Gateway Fabric. This is useful for advanced use cases where you need to configure NGINX directives that are not exposed through the Gateway API or other NGINX Gateway Fabric policies.

## Overview

`SnippetsPolicy` is an Attached Policy that targets a `Gateway` resource. It allows you to define snippets for specific NGINX contexts: `main`, `http`, and `http.server`.

> **Warning**: Using snippets can be dangerous. Incorrect snippets can cause NGINX to fail to reload or behave unexpectedly. Use with caution.

## Configuration

### SnippetsPolicy Spec

The `SnippetsPolicy` spec consists of a `targetRef` and a list of `snippets`.

- `targetRef`: Specifies the `Gateway` resource to attach the policy to.
- `snippets`: A list of snippets to inject. Each snippet consists of:
  - `context`: The NGINX context to inject the snippet into. Supported values: `main`, `http`, `http.server`.
  - `value`: The NGINX configuration snippet string.

### Validation

NGINX Gateway Fabric validates the `SnippetsPolicy` to ensure:
- Only one snippet is defined per context.
- The context is one of the supported values.
- The snippet size does not exceed the limit (4KB).

If a snippet is invalid (e.g., contains syntax errors), NGINX might fail to reload. NGINX Gateway Fabric attempts to validate the configuration using `nginx -t` before applying it. If validation fails, the configuration is not applied, and the `SnippetsPolicy` status is updated.

## Examples

### Basic Usage

The following example injects snippets into the `main`, `http`, and `http.server` contexts.

```yaml
apiVersion: gateway.nginx.org/v1alpha1
kind: SnippetsPolicy
metadata:
  name: example-snippets-policy
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: my-gateway
  snippets:
  - context: main
    value: |
      worker_priority -5;
  - context: http
    value: |
      keepalive_timeout 65;
  - context: http.server
    value: |
      gzip on;
      gzip_types text/plain application/xml;
```

### Enabling the Feature

To use `SnippetsPolicy`, you must enable the `snippetsPolicies` feature flag in the NGINX Gateway Fabric configuration.

If using Helm:

```yaml
nginxGateway:
  snippetsPolicies: true
```

If using the command line:

```bash
--snippets-policies=true
```
